<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ALL SEO TAGS SAME AS BEFORE -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ludo King WhatsApp Groups Live Links 2026 | JokerLudo</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50">
  
  <!-- HEADER SAME AS BEFORE -->
  <header class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white shadow-2xl sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <a href="/index.html" class="flex items-center space-x-3">
          <div class="w-16 h-16 bg-yellow-400 rounded-2xl flex items-center justify-center shadow-2xl">
            <i class="fas fa-dice text-3xl text-purple-900"></i>
          </div>
          <h1 class="text-3xl font-black">JokerLudo</h1>
        </a>
        <nav class="hidden md:flex space-x-2">
          <a href="/index.html" class="px-4 py-3 font-bold rounded-xl hover:bg-white/20">ğŸ  Home</a>
          <a href="/Addgrouplink.html" class="px-4 py-3 font-bold rounded-xl hover:bg-white/20">â• Add Group</a>
          <a href="/join.html" class="px-4 py-3 font-bold bg-yellow-300 text-purple-900 rounded-xl shadow-lg">ğŸ‘¥ Groups</a>
        </nav>
        <button class="md:hidden p-3 rounded-2xl hover:bg-white/20" onclick="toggleMenu()">
          <i class="fas fa-bars text-2xl"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="py-12 px-4 max-w-7xl mx-auto">
    <div class="text-center mb-16">
      <h1 class="text-5xl md:text-7xl font-black mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
        Live Ludo Groups
      </h1>
      <p class="text-2xl font-bold text-gray-700" id="liveCount">Loading...</p>
    </div>

    <!-- FILTERS -->
    <div class="flex flex-wrap gap-3 justify-center mb-12">
      <button class="filter-btn px-6 py-3 bg-purple-500 text-white font-bold rounded-xl shadow-xl active" data-filter="all">All</button>
      <button class="filter-btn px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-xl shadow-xl" data-filter="Ludo King">ğŸ² Ludo King</button>
      <button class="filter-btn px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-xl shadow-xl" data-filter="Ludo Star">â­ Ludo Star</button>
      <button class="filter-btn px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-xl shadow-xl" data-filter="Betting">ğŸ’° Betting</button>
    </div>

    <!-- GROUPS CONTAINER -->
    <div id="groupsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-16">
      <div class="col-span-full text-center py-20">
        <div class="w-24 h-24 border-4 border-gray-300 border-t-purple-500 rounded-full animate-spin mx-auto mb-8"></div>
        <h2 class="text-3xl font-black mb-4">Loading Groups...</h2>
      </div>
    </div>
  </main>

  <script>
    // ğŸ”¥ FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAMhdxU4pDqby11Ymixup2aCoEY5eZ3e7M",
      authDomain: "jokerludogroup-a8c97.firebaseapp.com",
      projectId: "jokerludogroup-a8c97",
      storageBucket: "jokerludogroup-a8c97.appspot.com",
      messagingSenderId: "1083106195650",
      appId: "1:1083106195650:web:fae27e9bb0798e96f4235b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let allGroups = [];
    let currentFilter = 'all';

    // ğŸ”¥ FIXED QUERY WITH FALLBACKS
    function loadGroups() {
      console.log('ğŸ”¥ Loading groups with multiple fallbacks...');
      
      // Primary: status = live
      db.collection('ludoGroups')
        .where('status', '==', 'live')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
          console.log('âœ… Live groups:', snapshot.docs.length);
          allGroups = snapshot.docs.map(doc => normalizeGroupData(doc));
          updateUI();
        }, error => {
          console.error('âŒ Live query failed:', error);
          loadAllGroups(); // Fallback 1
        });
    }

    // ğŸ”¥ NORMALIZE FIELD NAMES - THIS FIXES THE ISSUE!
    function normalizeGroupData(doc) {
      const data = doc.data();
      return {
        id: doc.id,
        name: data.name || 'Unnamed Group',
        category: data.category || data.groupCategory || 'Ludo King',  // ğŸ”¥ FIX 1
        link: data.link || data.groupLink || '#',                     // ğŸ”¥ FIX 2
        description: data.description || data.groupDesc || 'No description', // ğŸ”¥ FIX 3
        members: data.members || 0,
        status: data.status || 'live',
        timestamp: data.timestamp
      };
    }

    function loadAllGroups() {
      console.log('ğŸ”„ Fallback: Loading all groups...');
      db.collection('ludoGroups')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
          console.log('âœ… All groups:', snapshot.docs.length);
          allGroups = snapshot.docs.map(doc => normalizeGroupData(doc));
          updateUI();
        }, error => {
          console.error('âŒ Fallback failed:', error);
          loadSimpleGroups();
        });
    }

    function loadSimpleGroups() {
      console.log('ğŸ”„ Final fallback: Simple get...');
      db.collection('ludoGroups').limit(20).get().then(snapshot => {
        allGroups = snapshot.docs.map(doc => normalizeGroupData(doc));
        updateUI();
      }).catch(error => {
        console.error('âŒ All failed:', error);
        showNoGroups();
      });
    }

    function showNoGroups() {
      document.getElementById('groupsContainer').innerHTML = `
        <div class="col-span-full text-center py-20 bg-red-50 border-2 border-red-200 rounded-3xl p-8">
          <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
          <h2 class="text-4xl font-black text-red-600 mb-4">No Groups Found</h2>
          <p class="text-xl text-gray-600 mb-8">Add first group from <a href="/Addgrouplink.html" class="text-blue-600 font-bold">Add Group</a></p>
          <button onclick="debugQuery()" class="px-8 py-4 bg-purple-500 text-white font-bold rounded-2xl">ğŸ”§ Debug</button>
        </div>
      `;
    }

    function updateUI() {
      document.getElementById('liveCount').textContent = `${allGroups.length} Live Groups`;
      
      if (allGroups.length === 0) {
        showNoGroups();
        return;
      }

      renderGroups(allGroups);
      setupFilters();
    }

    function renderGroups(groups) {
      const container = document.getElementById('groupsContainer');
      const icons = { 'Ludo King': 'ğŸ²', 'Ludo Star': 'â­', 'Betting': 'ğŸ’°', 'Earning': 'ğŸ’µ' };
      
      container.innerHTML = groups.map(group => `
        <div class="bg-white rounded-2xl p-6 shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all border border-gray-100">
          <div class="flex items-start gap-3 mb-4">
            <div class="p-3 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl text-2xl font-bold">
              ${icons[group.category] || 'ğŸ®'}
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-xl font-black text-gray-900 line-clamp-1">${group.name}</h3>
              <div class="flex gap-2 mt-2">
                <span class="px-3 py-1 bg-purple-500 text-white text-xs font-bold rounded-lg">${group.category}</span>
                <span class="text-sm text-gray-600">ğŸ‘¥ ${group.members}+ Members</span>
              </div>
            </div>
          </div>
          <p class="text-gray-700 text-sm line-clamp-3 mb-4">${group.description}</p>
          <a href="${group.link}" target="_blank" class="w-full block bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-3 px-6 rounded-xl font-bold text-center hover:from-emerald-600 hover:shadow-xl transition-all">
            ğŸš€ Join WhatsApp Group
          </a>
        </div>
      `).join('');
    }

    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active', 'bg-purple-500', 'text-white');
            b.classList.add('bg-gray-200', 'text-gray-800');
          });
          btn.classList.add('active', 'bg-purple-500', 'text-white');
          btn.classList.remove('bg-gray-200', 'text-gray-800');
          
          currentFilter = btn.dataset.filter;
          const filtered = currentFilter === 'all' ? allGroups : 
            allGroups.filter(g => g.category === currentFilter);
          renderGroups(filtered);
        };
      });
    }

    // ğŸ”¥ DEBUG FUNCTION
    function debugQuery() {
      console.log('ğŸ§ª DEBUG: Testing database...');
      db.collection('ludoGroups').limit(5).get().then(snapshot => {
        console.log('ğŸ“Š Total groups:', snapshot.size);
        console.log('ğŸ“‹ Sample data:', snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            name: data.name,
            category: data.category || data.groupCategory,
            link: data.link || data.groupLink,
            description: data.description || data.groupDesc,
            status: data.status,
            members: data.members
          };
        }));
        alert(`Found ${snapshot.size} groups!\nCheck console (F12) for details`);
      }).catch(err => {
        console.error('Debug failed:', err);
        alert('Debug failed: ' + err.message);
      });
    }

    function toggleMenu() {
      // Mobile menu toggle
      document.getElementById('mobileMenu')?.classList.toggle('hidden');
    }

    // ğŸ”¥ AUTO START
    window.onload = () => {
      console.log('ğŸš€ Join.html loaded - Starting queries...');
      loadGroups();
    };
  </script>
</body>
</html>
