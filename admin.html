<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Groups</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .container { 
      max-width: 1200px; 
      margin: auto; 
      background: rgba(255,255,255,0.95); 
      padding: 30px; 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    .header { 
      text-align: center; 
      margin-bottom: 30px; 
      color: #2c3e50;
    }
    .header h1 { 
      font-size: 2.5em; 
      margin: 0; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .logout { 
      background: linear-gradient(45deg, #ff6b6b, #ee5a52); 
      margin-bottom: 20px; 
      float: right; 
      padding: 12px 24px; 
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .logout:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,107,107,0.3); }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
    
    input, select, textarea {
      width: 100%; 
      padding: 15px; 
      margin: 8px 0; 
      border: 2px solid #e1e8ed; 
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.8);
    }
    input:focus, select:focus, textarea:focus {
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
      transform: translateY(-2px);
    }
    
    .checkbox-group { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 15px; 
      margin: 15px 0; 
    }
    .checkbox-group label { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      cursor: pointer; 
      padding: 10px 15px; 
      border-radius: 8px; 
      background: rgba(102,126,234,0.1);
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .checkbox-group label:hover { background: rgba(102,126,234,0.2); }
    
    button {
      padding: 15px 30px; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; 
      border: none; 
      border-radius: 12px; 
      cursor: pointer; 
      font-size: 16px; 
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 5px;
    }
    button:hover:not(:disabled) { 
      transform: translateY(-3px); 
      box-shadow: 0 15px 30px rgba(102,126,234,0.4); 
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .loading { background: linear-gradient(45deg, #28a745, #20c997) !important; }
    .cancel { background: linear-gradient(45deg, #6c757d, #495057) !important; }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    th { 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; 
      padding: 20px; 
      text-align: left; 
      font-weight: 600;
    }
    td { 
      padding: 20px; 
      border-bottom: 1px solid #eee; 
    }
    tr:hover { background: rgba(102,126,234,0.05); }
    
    .status-active { color: #28a745; font-weight: bold; }
    .status-inactive { color: #dc3545; font-weight: bold; }
    
    .actions button { 
      padding: 8px 12px; 
      margin: 0 5px 0 0; 
      font-size: 14px; 
    }
    .actions .edit { background: linear-gradient(45deg, #17a2b8, #138496); }
    .actions .delete { background: linear-gradient(45deg, #dc3545, #c82333); }
    
    .message { 
      padding: 15px 20px; 
      border-radius: 12px; 
      margin: 20px 0; 
      font-weight: 500;
    }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    #loadingMsg { 
      text-align: center; 
      padding: 40px; 
      color: #666; 
      font-size: 18px;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
  </style>
</head>
<body>

<div class="container">
  <button class="logout" onclick="logoutApp()" id="logoutBtn">ğŸšª Logout</button>
  <div class="header">
    <h1>ğŸ“Œ Admin Panel - Group Manager</h1>
    <p>Complete control over your gaming groups</p>
  </div>
  
  <div id="loadingMsg">ğŸ”„ Initializing Admin Panel... <span class="spinner"></span></div>
  <div id="errorMsg" class="message error" style="display:none;"></div>

  <!-- Admin Form -->
  <div class="form-section">
    <h3 id="formTitle">â• Add New Group</h3>
    <form id="groupForm">
      <div class="form-grid">
        <div>
          <input type="text" id="name" placeholder="ğŸ“› Group Name" maxlength="100" required>
          <input type="url" id="link" placeholder="ğŸ”— WhatsApp/Telegram Link" maxlength="500" required>
        </div>
        <div>
          <select id="groupType" required>
            <option value="">ğŸ® Select Game Type</option>
            <option value="Cricket">ğŸ Cricket</option>
            <option value="Football">âš½ Football</option>
            <option value="Tennis">ğŸ¾ Tennis</option>
            <option value="Ludo">ğŸ² Ludo</option>
            <option value="Other">ğŸ“Œ Other Games</option>
          </select>
          <textarea id="description" placeholder="ğŸ“ Short Description (Optional)" maxlength="500"></textarea>
        </div>
      </div>
      
      <label>ğŸ“± Platforms</label>
      <div class="checkbox-group">
        <label><input type="checkbox" class="platform" value="WhatsApp" checked> ğŸ“± WhatsApp</label>
        <label><input type="checkbox" class="platform" value="Telegram"> ğŸ’¬ Telegram</label>
        <label><input type="checkbox" class="platform" value="Facebook"> ğŸ“˜ Facebook</label>
        <label><input type="checkbox" class="platform" value="Other"> ğŸŒ Other</label>
      </div>
      
      <button type="submit" id="submitBtn">â• Add New Group</button>
      <button type="button" id="cancelBtn" class="cancel" onclick="cancelEdit()" style="display:none;">âŒ Cancel Edit</button>
    </form>
  </div>

  <!-- Groups Table -->
  <h3>ğŸ“Š Groups Dashboard (<span id="groupsCount">0</span>)</h3>
  <table>
    <thead>
      <tr>
        <th>ğŸ“› Name</th>
        <th>ğŸ”— Link</th>
        <th>ğŸ·ï¸ Game Type</th>
        <th>ğŸ“± Platforms</th>
        <th>ğŸ“ Description</th>
        <th>Status</th>
        <th>Date Added</th>
        <th>âš™ï¸ Actions</th>
      </tr>
    </thead>
    <tbody id="groupsTable"></tbody>
  </table>
</div>

<script>
  // ğŸ”¥ FIREBASE CONFIG (UNCHANGED)
  const firebaseConfig = {
    apiKey: "AIzaSyCwdlnLXcXauh3_YmY6cwswqzcieMOHI0Y",
    authDomain: "ludogroup-a530a.firebaseapp.com",
    projectId: "ludogroup-a530a",
    storageBucket: "ludogroup-a530a.appspot.com",
    messagingSenderId: "838421084676",
    appId: "1:838421084676:web:9e02670e280eafcd86d351"
  };

  // âœ… SAFE INIT
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  let editingId = null;
  let unsubscribeGroups = null;

  // ğŸ”’ SAFE TEXT SANITIZER (URL KE LIYE NAHI)
  const cleanText = (str) =>
    str.replace(/[<>]/g, "").trim().substring(0, 200);

  const showMessage = (msg, type = "error") => {
    const box = document.getElementById("errorMsg");
    box.textContent = msg;
    box.className = `message ${type}`;
    box.style.display = "block";
    setTimeout(() => box.style.display = "none", 4000);
  };

  // ğŸ” AUTH CHECK
  auth.onAuthStateChanged(async (user) => {
    document.getElementById("loadingMsg").style.display = "none";

    if (!user) {
      location.href = "privacy.html";
      return;
    }

    try {
      const adminSnap = await db.collection("admins").doc(user.uid).get();
      if (!adminSnap.exists) {
        showMessage("ğŸš« Admin access required");
        auth.signOut();
        return;
      }

      document.querySelector(".form-section").style.display = "block";
      loadGroups();
      showMessage("âœ… Admin panel loaded", "success");
    } catch (err) {
      showMessage(err.message);
      auth.signOut();
    }
  });

  // â• ADD / UPDATE GROUP
  document.getElementById("groupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = cleanText(nameInput.value);
    const link = linkInput.value.trim(); // â— URL NOT sanitized
    const groupType = groupTypeInput.value;
    const description = cleanText(descriptionInput.value);
    const platforms = [...document.querySelectorAll(".platform:checked")].map(p => p.value);

    if (!name || !link || !groupType || !platforms.length) {
      showMessage("âš ï¸ Fill all required fields");
      return;
    }

    const data = {
      name,
      link,
      type: groupType,
      platforms,
      description,
      status: "active",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      if (editingId) {
        await db.collection("Groups").doc(editingId).update(data);
        showMessage("âœ… Group updated", "success");
      } else {
        await db.collection("Groups").add({
          ...data,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showMessage("âœ… Group added", "success");
      }
      resetForm();
    } catch (err) {
      showMessage(err.message);
    }
  });

  // ğŸ“Š LOAD GROUPS (FIXED ORDER ISSUE)
  function loadGroups() {
    const tbody = document.getElementById("groupsTable");

    unsubscribeGroups = db.collection("Groups")
      .orderBy("updatedAt", "desc")
      .onSnapshot(snapshot => {
        tbody.innerHTML = "";
        groupsCount.textContent = snapshot.size;

        snapshot.forEach(doc => {
          const g = doc.data();
          const date =
            g.createdAt?.toDate().toLocaleDateString() ||
            g.updatedAt?.toDate().toLocaleDateString() ||
            "N/A";

          tbody.innerHTML += `
            <tr>
              <td><strong>${g.name}</strong></td>
              <td><a href="${g.link}" target="_blank">ğŸ”— Open</a></td>
              <td>${g.type}</td>
              <td>${(g.platforms || []).join(" â€¢ ")}</td>
              <td>${g.description || "-"}</td>
              <td><b>${(g.status || "active").toUpperCase()}</b></td>
              <td>${date}</td>
              <td class="actions">
                <button class="edit" onclick="editGroup('${doc.id}')">âœï¸</button>
                <button class="delete" onclick="deleteGroup('${doc.id}')">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        });
      }, err => showMessage(err.message));
  }

  // âœï¸ EDIT
  window.editGroup = async (id) => {
    const snap = await db.collection("Groups").doc(id).get();
    if (!snap.exists) return;

    const g = snap.data();
    editingId = id;

    nameInput.value = g.name;
    linkInput.value = g.link;
    groupTypeInput.value = g.type;
    descriptionInput.value = g.description || "";

    document.querySelectorAll(".platform").forEach(cb => {
      cb.checked = (g.platforms || []).includes(cb.value);
    });

    formTitle.textContent = "âœï¸ Edit Group";
    submitBtn.textContent = "âœ… Update Group";
    cancelBtn.style.display = "inline-block";
  };

  // ğŸ—‘ï¸ DELETE
  window.deleteGroup = async (id) => {
    if (!confirm("Delete this group?")) return;
    await db.collection("Groups").doc(id).delete();
    showMessage("ğŸ—‘ï¸ Group deleted", "success");
  };

  // ğŸ”„ RESET
  function resetForm() {
    groupForm.reset();
    document.querySelector('.platform[value="WhatsApp"]').checked = true;
    editingId = null;
    cancelBtn.style.display = "none";
    submitBtn.textContent = "â• Add New Group";
    formTitle.textContent = "â• Add New Group";
  }

  function cancelEdit() {
    resetForm();
  }

  function logoutApp() {
    auth.signOut().then(() => location.href = "privacy.html");
  }
</script>
</body>
</html>










