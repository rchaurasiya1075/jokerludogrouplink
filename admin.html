<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Groups</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .container { 
      max-width: 1200px; 
      margin: auto; 
      background: rgba(255,255,255,0.95); 
      padding: 30px; 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    .header { 
      text-align: center; 
      margin-bottom: 30px; 
      color: #2c3e50;
    }
    .header h1 { 
      font-size: 2.5em; 
      margin: 0; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .logout { 
      background: linear-gradient(45deg, #ff6b6b, #ee5a52); 
      margin-bottom: 20px; 
      float: right; 
      padding: 12px 24px; 
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .logout:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,107,107,0.3); }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
    
    input, select, textarea {
      width: 100%; 
      padding: 15px; 
      margin: 8px 0; 
      border: 2px solid #e1e8ed; 
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.8);
    }
    input:focus, select:focus, textarea:focus {
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
      transform: translateY(-2px);
    }
    
    .checkbox-group { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 15px; 
      margin: 15px 0; 
    }
    .checkbox-group label { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      cursor: pointer; 
      padding: 10px 15px; 
      border-radius: 8px; 
      background: rgba(102,126,234,0.1);
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .checkbox-group label:hover { background: rgba(102,126,234,0.2); }
    
    button {
      padding: 15px 30px; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; 
      border: none; 
      border-radius: 12px; 
      cursor: pointer; 
      font-size: 16px; 
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 5px;
    }
    button:hover:not(:disabled) { 
      transform: translateY(-3px); 
      box-shadow: 0 15px 30px rgba(102,126,234,0.4); 
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .loading { background: linear-gradient(45deg, #28a745, #20c997) !important; }
    .cancel { background: linear-gradient(45deg, #6c757d, #495057) !important; }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    th { 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; 
      padding: 20px; 
      text-align: left; 
      font-weight: 600;
    }
    td { 
      padding: 20px; 
      border-bottom: 1px solid #eee; 
    }
    tr:hover { background: rgba(102,126,234,0.05); }
    
    .status-active { color: #28a745; font-weight: bold; }
    .status-inactive { color: #dc3545; font-weight: bold; }
    
    .actions button { 
      padding: 8px 12px; 
      margin: 0 5px 0 0; 
      font-size: 14px; 
    }
    .actions .edit { background: linear-gradient(45deg, #17a2b8, #138496); }
    .actions .delete { background: linear-gradient(45deg, #dc3545, #c82333); }
    
    .message { 
      padding: 15px 20px; 
      border-radius: 12px; 
      margin: 20px 0; 
      font-weight: 500;
    }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    #loadingMsg { 
      text-align: center; 
      padding: 40px; 
      color: #666; 
      font-size: 18px;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
  </style>
</head>
<body>

<div class="container">
  <button class="logout" onclick="logoutApp()" id="logoutBtn">ğŸšª Logout</button>
  <div class="header">
    <h1>ğŸ“Œ Admin Panel - Group Manager</h1>
    <p>Complete control over your gaming groups</p>
  </div>
  
  <div id="loadingMsg">ğŸ”„ Initializing Admin Panel... <span class="spinner"></span></div>
  <div id="errorMsg" class="message error" style="display:none;"></div>

  <!-- Admin Form -->
  <div class="form-section">
    <h3 id="formTitle">â• Add New Group</h3>
    <form id="groupForm">
      <div class="form-grid">
        <div>
          <input type="text" id="name" placeholder="ğŸ“› Group Name" maxlength="100" required>
          <input type="url" id="link" placeholder="ğŸ”— WhatsApp/Telegram Link" maxlength="500" required>
        </div>
        <div>
          <select id="groupType" required>
            <option value="">ğŸ® Select Game Type</option>
            <option value="Cricket">ğŸ Cricket</option>
            <option value="Football">âš½ Football</option>
            <option value="Tennis">ğŸ¾ Tennis</option>
            <option value="Ludo">ğŸ² Ludo</option>
            <option value="Other">ğŸ“Œ Other Games</option>
          </select>
          <textarea id="description" placeholder="ğŸ“ Short Description (Optional)" maxlength="500"></textarea>
        </div>
      </div>
      
      <label>ğŸ“± Platforms</label>
      <div class="checkbox-group">
        <label><input type="checkbox" class="platform" value="WhatsApp" checked> ğŸ“± WhatsApp</label>
        <label><input type="checkbox" class="platform" value="Telegram"> ğŸ’¬ Telegram</label>
        <label><input type="checkbox" class="platform" value="Facebook"> ğŸ“˜ Facebook</label>
        <label><input type="checkbox" class="platform" value="Other"> ğŸŒ Other</label>
      </div>
      
      <button type="submit" id="submitBtn">â• Add New Group</button>
      <button type="button" id="cancelBtn" class="cancel" onclick="cancelEdit()" style="display:none;">âŒ Cancel Edit</button>
    </form>
  </div>

  <!-- Groups Table -->
  <h3>ğŸ“Š Groups Dashboard (<span id="groupsCount">0</span>)</h3>
  <table>
    <thead>
      <tr>
        <th>ğŸ“› Name</th>
        <th>ğŸ”— Link</th>
        <th>ğŸ·ï¸ Game Type</th>
        <th>ğŸ“± Platforms</th>
        <th>ğŸ“ Description</th>
        <th>Status</th>
        <th>Date Added</th>
        <th>âš™ï¸ Actions</th>
      </tr>
    </thead>
    <tbody id="groupsTable"></tbody>
  </table>
</div>

<script>
  // ğŸ”¥ SECURE FIREBASE CONFIG - DON'T EXPOSE IN PRODUCTION
  const firebaseConfig = {
    apiKey: "AIzaSyCwdlnLXcXauh3_YmY6cwswqzcieMOHI0Y",
    authDomain: "ludogroup-a530a.firebaseapp.com",
    projectId: "ludogroup-a530a",
    storageBucket: "ludogroup-a530a.appspot.com",
    messagingSenderId: "838421084676",
    appId: "1:838421084676:web:9e02670e280eafcd86d351"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ğŸ”¥ STATE MANAGEMENT
  let editingId = null;
  let authChecked = false;
  let unsubscribeAuth = null;
  let unsubscribeGroups = null;

  // ğŸ”’ UTILITY FUNCTIONS
  const sanitizeInput = (str) => {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML.replace(/[^\w\sğŸ˜€-ğŸ™ğŸ€„ğŸ¯ğŸ®ğŸ“±ğŸ“›ğŸ”—âš½ğŸğŸ¾ğŸ²]/g, '').trim().substring(0, 100);
  };

  const showMessage = (msg, type = 'error') => {
    const msgDiv = document.getElementById('errorMsg');
    msgDiv.textContent = msg;
    msgDiv.className = `message ${type}`;
    msgDiv.style.display = 'block';
    setTimeout(() => msgDiv.style.display = 'none', 5000);
  };

  const setLoading = (loading = true) => {
    const btn = document.getElementById('submitBtn');
    if (loading) {
      btn.disabled = true;
      btn.innerHTML = 'â³ Processing... <span class="spinner"></span>';
      btn.classList.add('loading');
    } else {
      btn.disabled = false;
      btn.innerHTML = editingId ? 'âœ… Update Group' : 'â• Add New Group';
      btn.classList.remove('loading');
    }
  };

  // ğŸ” ADMIN AUTHENTICATION
  const initAuth = async () => {
    unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
      if (authChecked) return;
      authChecked = true;
      
      document.getElementById('loadingMsg').style.display = 'none';

      if (!user) {
        window.location.href = "privacy.html";
        return;
      }

      try {
        // ğŸ”¥ CHECK ADMIN PRIVILEGES
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (!adminDoc.exists) {
          showMessage('ğŸš« Access Denied: Admin privileges required!');
          setTimeout(() => logoutApp(), 2000);
          return;
        }
        
        // âœ… ADMIN APPROVED - LOAD DASHBOARD
        document.querySelector('.form-section').style.display = 'block';
        renderGroups();
        showMessage('âœ… Welcome Admin! Dashboard loaded.', 'success');
        
      } catch (error) {
        showMessage('âŒ Auth Error: ' + error.message);
        logoutApp();
      }
    });
  };

  // ğŸšª SECURE LOGOUT
  const logoutApp = () => {
    if (unsubscribeAuth) unsubscribeAuth();
    if (unsubscribeGroups) unsubscribeGroups();
    auth.signOut().then(() => {
      window.location.href = "privacy.html";
    }).catch(() => {
      window.location.href = "privacy.html";
    });
  };

  // ğŸ“ FORM MANAGEMENT
  const resetForm = () => {
    document.getElementById('groupForm').reset();
    document.querySelector('.platform[value="WhatsApp"]').checked = true;
    document.getElementById('formTitle').textContent = 'â• Add New Group';
    document.getElementById('submitBtn').textContent = 'â• Add New Group';
    document.getElementById('cancelBtn').style.display = 'none';
    editingId = null;
  };

  const cancelEdit = () => resetForm();

  // â• MAIN FORM SUBMISSION
  document.getElementById('groupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);

    const name = sanitizeInput(document.getElementById('name').value);
    const link = sanitizeInput(document.getElementById('link').value);
    const groupType = document.getElementById('groupType').value;
    const description = sanitizeInput(document.getElementById('description').value);
    const platforms = Array.from(document.querySelectorAll('.platform:checked')).map(cb => cb.value);

    if (!name || !link || !groupType || !platforms.length) {
      showMessage('âš ï¸ Please fill all required fields correctly!');
      setLoading(false);
      return;
    }

    try {
      if (editingId) {
        // UPDATE GROUP
        await db.collection('Groups').doc(editingId).update({
          name, link, type: groupType, platforms, description,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showMessage('âœ… Group updated successfully!');
      } else {
        // ADD NEW GROUP
        await db.collection('Groups').add({
          name, link, type: groupType, platforms, description,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showMessage('âœ… New group added successfully!');
      }
      resetForm();
    } catch (error) {
      showMessage('âŒ Database Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  });

  // ğŸ“Š RENDER GROUPS TABLE
  const renderGroups = () => {
    const tbody = document.getElementById('groupsTable');
    unsubscribeGroups = db.collection('Groups')
      .orderBy('createdAt', 'desc')
      .limit(100)
      .onSnapshot(snapshot => {
        tbody.innerHTML = '';
        const count = snapshot.size;
        document.getElementById('groupsCount').textContent = count;
        
        snapshot.forEach(doc => {
          const group = doc.data();
          const date = group.createdAt ? group.createdAt.toDate().toLocaleDateString() : 'N/A';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${group.name || 'Unnamed'}</strong></td>
            <td><a href="${group.link}" target="_blank" rel="noopener noreferrer">ğŸ”— Open</a></td>
            <td>${group.type || 'Unknown'}</td>
            <td>${(group.platforms || []).join(' â€¢ ')}</td>
            <td>${group.description || '-'}</td>
            <td><span class="status-${group.status || 'unknown'}">${group.status?.toUpperCase() || 'UNKNOWN'}</span></td>
            <td>${date}</td>
            <td class="actions">
              <button class="edit" onclick="editGroup('${doc.id}')" title="Edit Group">âœï¸</button>
              <button class="delete" onclick="deleteGroup('${doc.id}')" title="Delete Group">ğŸ—‘ï¸</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }, error => {
        showMessage('âŒ Failed to load groups: ' + error.message);
      });
  };

  // âœï¸ EDIT GROUP
  window.editGroup = async (id) => {
    editingId = id;
    const doc = await db.collection('Groups').doc(id).get();
    if (!doc.exists) return showMessage('âŒ Group not found!');
    
    const group = doc.data();
    document.getElementById('name').value = group.name || '';
    document.getElementById('link').value = group.link || '';
    document.getElementById('groupType').value = group.type || '';
    document.getElementById('description').value = group.description || '';
    
    // Set platforms
    document.querySelectorAll('.platform').forEach(cb => {
      cb.checked = (group.platforms || []).includes(cb.value);
    });
    
    document.getElementById('formTitle').textContent = 'âœï¸ Edit Group';
    document.getElementById('submitBtn').textContent = 'âœ… Update Group';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    
    // Scroll to form
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
  };

  // ğŸ—‘ï¸ DELETE GROUP
  window.deleteGroup = async (id) => {
    if (!confirm('âš ï¸ Delete this group permanently? This cannot be undone!')) return;
    
    try {
      await db.collection('Groups').doc(id).delete();
      showMessage('ğŸ—‘ï¸ Group deleted successfully!');
    } catch (error) {
      showMessage('âŒ Delete failed: ' + error.message);
    }
  };

  // ğŸš€ INITIALIZE APP
  document.querySelector('.form-section').style.display = 'none';
  initAuth();

  // ğŸ§¹ CLEANUP
  window.addEventListener('beforeunload', () => {
    if (unsubscribeAuth) unsubscribeAuth();
    if (unsubscribeGroups) unsubscribeGroups();
  });
</script>
</body>
</html>
